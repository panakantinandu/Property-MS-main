<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{csrfToken}}">
    <title>Admin Dashboard - LeaseHub</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #f5f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem 2rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .navbar-brand { color: white !important; font-weight: 700; font-size: 1.5rem; }
        .nav-link { color: rgba(255, 255, 255, 0.9) !important; margin: 0 10px; transition: all 0.3s; }
        .nav-link:hover { color: white !important; transform: translateY(-2px); }
        .main-content { padding: 30px; max-width: 1400px; margin: 0 auto; }
        
        /* Alert Cards */
        .alert-section { margin-bottom: 30px; }
        .alert-card { background: white; border-left: 4px solid; padding: 20px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .alert-card.danger { border-left-color: #dc3545; }
        .alert-card.warning { border-left-color: #ffc107; }
        .alert-card.info { border-left-color: #17a2b8; }
        .alert-card h6 { margin: 0 0 10px 0; font-weight: 600; }
        .alert-card .count { font-size: 2rem; font-weight: 700; }
        .alert-card.danger .count { color: #dc3545; }
        .alert-card.warning .count { color: #ffc107; }
        .alert-card.info .count { color: #17a2b8; }
        
        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15); }
        .stat-card .icon { font-size: 2.5rem; margin-bottom: 15px; }
        .stat-card .value { font-size: 2rem; font-weight: 700; margin: 10px 0; }
        .stat-card .label { color: #7f8c8d; font-size: 0.9rem; text-transform: uppercase; }
        .stat-card.primary { border-top: 4px solid #667eea; }
        .stat-card.primary .icon { color: #667eea; }
        .stat-card.success { border-top: 4px solid #4caf50; }
        .stat-card.success .icon { color: #4caf50; }
        .stat-card.warning { border-top: 4px solid #ff9800; }
        .stat-card.warning .icon { color: #ff9800; }
        .stat-card.danger { border-top: 4px solid #f44336; }
        .stat-card.danger .icon { color: #f44336; }
        
        .data-table { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .table { margin: 0; }
        .table th { background: #f8f9fa; border: none; color: #2c3e50; font-weight: 600; }
        .table td { vertical-align: middle; }
        
        .badge-danger { background: #dc3545; padding: 6px 12px; border-radius: 20px; }
        .badge-warning { background: #ffc107; padding: 6px 12px; border-radius: 20px; color: #000; }
        .badge-success { background: #28a745; padding: 6px 12px; border-radius: 20px; }
        
        .quick-actions { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .quick-actions h5 { margin-bottom: 20px; color: #2c3e50; }
        .quick-action-btn { width: 100%; margin-bottom: 10px; padding: 12px; font-weight: 600; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <a class="navbar-brand" href="/admin/dashboard">üè¢ LeaseHub Admin</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item"><a class="nav-link active" href="/admin/dashboard">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="/admin/tenants">Tenants</a></li>
                <li class="nav-item"><a class="nav-link" href="/admin/properties">Properties</a></li>
                <li class="nav-item"><a class="nav-link" href="/admin/applications">Applications</a></li>
                <li class="nav-item"><a class="nav-link" href="/admin/payments">Payments</a></li>
                <li class="nav-item"><a class="nav-link" href="/admin/logout">Logout</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Welcome, {{adminName}}! üëã</h2>
            <div class="text-muted">
                <i class="fas fa-calendar-alt"></i> {{currentDate}}
            </div>
        </div>

        <!-- Critical Alerts -->
        {{#if (or alerts.overduePayments alerts.expiringLeases alerts.pendingMaintenance alerts.tenantsOverdue5Plus alerts.totalOutstandingRent alerts.repeatLatePayers)}}
        <div class="alert-section">
            <div class="row">
                {{#if alerts.overduePayments}}
                <div class="col-md-4">
                    <div class="alert-card danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> Overdue Payments</h6>
                        <div class="count">{{alerts.overduePayments}}</div>
                        <p class="mb-0 text-muted">Requires immediate attention</p>
                        <a href="/admin/payments?filter=overdue" class="btn btn-sm btn-danger mt-2">View Details</a>
                    </div>
                </div>
                {{/if}}
                
                {{#if alerts.expiringLeases}}
                <div class="col-md-4">
                    <div class="alert-card warning">
                        <h6><i class="fas fa-calendar-times"></i> Leases Expiring Soon</h6>
                        <div class="count">{{alerts.expiringLeases}}</div>
                        <p class="mb-0 text-muted">Within next 30 days</p>
                        <a href="/admin/tenants?filter=expiring" class="btn btn-sm btn-warning mt-2">View Tenants</a>
                    </div>
                </div>
                {{/if}}
                
                {{#if alerts.pendingMaintenance}}
                <div class="col-md-4">
                    <div class="alert-card info">
                        <h6><i class="fas fa-tools"></i> Pending Maintenance</h6>
                        <div class="count">{{alerts.pendingMaintenance}}</div>
                        <p class="mb-0 text-muted">Open maintenance requests</p>
                        <a href="/admin/maintenance" class="btn btn-sm btn-info mt-2">View Requests</a>
                    </div>
                </div>
                {{/if}}

                <div class="col-md-4 mt-3">
                    <div class="alert-card danger">
                        <h6><i class="fas fa-dollar-sign"></i> Total Outstanding Rent</h6>
                        <div class="count">{{currencySymbol}}{{alerts.totalOutstandingRent}}</div>
                        <p class="mb-1 text-muted">Across all unpaid / overdue rent invoices</p>
                        <a href="/admin/rent/overdue" class="btn btn-sm btn-danger">View Overdue Rent</a>
                    </div>
                </div>

                <div class="col-md-4 mt-3">
                    <div class="alert-card warning">
                        <h6><i class="fas fa-user-clock"></i> Tenants Overdue &gt; 5 Days</h6>
                        <div class="count">{{alerts.tenantsOverdue5Plus}}</div>
                        <p class="mb-1 text-muted">Tenants with rent late more than 5 days</p>
                        <a href="/admin/rent/overdue" class="btn btn-sm btn-warning">View Details</a>
                    </div>
                </div>

                <div class="col-md-4 mt-3">
                    <div class="alert-card warning">
                        <h6><i class="fas fa-user-times"></i> Repeat Late Payers</h6>
                        <div class="count">{{alerts.repeatLatePayers}}</div>
                        <p class="mb-0 text-muted">Tenants with multiple late rent invoices</p>
                    </div>
                </div>
            </div>
        </div>
        {{/if}}

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="icon"><i class="fas fa-users"></i></div>
                <div class="value">{{stats.totalTenants}}</div>
                <div class="label">Total Tenants</div>
                <a href="/admin/tenants" class="btn btn-sm btn-outline-primary mt-2">View All</a>
            </div>
            
            <div class="stat-card success">
                <div class="icon"><i class="fas fa-home"></i></div>
                <div class="value">{{stats.totalProperties}}</div>
                <div class="label">Total Properties</div>
                <a href="/admin/properties" class="btn btn-sm btn-outline-success mt-2">View All</a>
            </div>
            
            <div class="stat-card warning">
                <div class="icon"><i class="fas fa-file-alt"></i></div>
                <div class="value">{{stats.pendingApplications}}</div>
                <div class="label">Pending Applications</div>
                <a href="/admin/applications?filter=pending" class="btn btn-sm btn-outline-warning mt-2">Review Now</a>
            </div>
            
            <div class="stat-card danger">
                <div class="icon"><i class="fas fa-door-open"></i></div>
                <div class="value">{{stats.occupiedProperties}}</div>
                <div class="label">Occupied Properties</div>
            </div>
            
            <div class="stat-card danger">
                <div class="icon"><i class="fas fa-door-closed"></i></div>
                <div class="value">{{stats.availableProperties}}</div>
                <div class="label">Available Properties</div>
            </div>
        </div>

        <div class="row">
            <!-- Quick Actions -->
            <div class="col-md-3">
                <div class="quick-actions">
                    <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                    <a href="/admin/tenants/add" class="btn btn-primary quick-action-btn">
                        <i class="fas fa-user-plus"></i> Add New Tenant
                    </a>
                    <a href="/admin/properties/add" class="btn btn-success quick-action-btn">
                        <i class="fas fa-home"></i> Add New Property
                    </a>
                    <a href="/admin/payments?filter=pending" class="btn btn-warning quick-action-btn">
                        <i class="fas fa-credit-card"></i> Pending Payments
                    </a>
                    <a href="/admin/reports" class="btn btn-info quick-action-btn">
                        <i class="fas fa-chart-bar"></i> View Reports
                    </a>
                </div>

                <!-- Payment Predictions -->
                {{#if predictions.length}}
                <div class="data-table">
                    <h5><i class="fas fa-brain"></i> Late Payment Predictions</h5>
                    <p class="text-muted small">AI-predicted late payments</p>
                    <div class="list-group">
                        {{#each predictions}}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <strong>{{this.tenantName}}</strong>
                                <span class="badge-danger">{{this.riskLevel}}%</span>
                            </div>
                            <small class="text-muted">{{this.propertyName}}</small>
                        </div>
                        {{/each}}
                    </div>
                </div>
                {{/if}}
            </div>

            <!-- Recent Activity -->
            <div class="col-md-9">
                <!-- Upcoming Rent Due -->
                {{#if upcomingDues.length}}
                <div class="data-table">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-calendar-check"></i> Upcoming Rent Due (Next 7 Days)</h5>
                        <span class="badge badge-info">{{upcomingDues.length}} tenants</span>
                    </div>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Tenant</th>
                                <th>Property</th>
                                <th>Due Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each upcomingDues}}
                            <tr>
                                <td><strong>{{this.tenantName}}</strong></td>
                                <td>{{this.propertyName}}</td>
                                <td>{{this.dueDate}}</td>
                                <td><strong>{{currencySymbol}}{{this.amount}}</strong></td>
                                <td><span class="badge-warning">Due Soon</span></td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="sendReminder('{{this.tenantId}}')">
                                        <i class="fas fa-bell"></i> Send Reminder
                                    </button>
                                </td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
                {{/if}}

                <!-- Recent Payments -->
                {{#if recentPayments.length}}
                <div class="data-table">
                    <h5><i class="fas fa-money-bill-wave"></i> Recent Payments</h5>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Tenant</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each recentPayments}}
                            <tr>
                                <td>{{this.paymentDate}}</td>
                                <td>
                                    {{#if this.tenantId}}
                                        {{this.tenantId.firstname}} {{this.tenantId.lastname}}
                                    {{else}}
                                        N/A
                                    {{/if}}
                                </td>
                                <td><strong>{{currencySymbol}}{{this.amountPaid}}</strong></td>
                                <td>{{this.paymentMethod}}</td>
                                <td>
                                    {{#if (eq this.status 'approved')}}
                                        <span class="badge-success">Approved</span>
                                    {{else}}
                                        <span class="badge-warning">{{this.status}}</span>
                                    {{/if}}
                                </td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
                {{/if}}

                <!-- Pending Invoices -->
                {{#if pendingInvoices.length}}
                <div class="data-table">
                    <h5><i class="fas fa-file-invoice-dollar"></i> Pending Invoices</h5>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Tenant</th>
                                <th>Invoice Date</th>
                                <th>Due Date</th>
                                <th>Amount / Details</th>
                                <th>Status</th>
                                <th>Days Overdue</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each pendingInvoices}}
                            <tr>
                                <td>
                                    {{#if this.tenantId}}
                                        {{this.tenantId.firstname}} {{this.tenantId.lastname}}
                                    {{else}}
                                        N/A
                                    {{/if}}
                                </td>
                                <td>{{this.invoiceDate}}</td>
                                <td>{{this.dueDate}}</td>
                                <td>
                                    {{#if (eq this.type 'booking_deposit')}}
                                        <strong>{{currencySymbol}}{{this.totalAmount}}</strong>
                                        <div class="text-muted small">
                                            Booking deposit
                                            {{#if this.propertyId}}
                                                &mdash; Total rent: {{currencySymbol}}{{this.propertyId.rent}}
                                            {{/if}}
                                        </div>
                                    {{else}}
                                        <strong>{{currencySymbol}}{{this.totalAmount}}</strong>
                                        <div class="text-muted small">
                                            {{#if this.type}}
                                                Invoice type: {{this.type}}
                                            {{/if}}
                                        </div>
                                    {{/if}}
                                </td>
                                <td>
                                    {{#if (eq this.status 'overdue')}}
                                        <span class="badge-danger">Overdue</span>
                                    {{else}}
                                        <span class="badge-warning">Unpaid</span>
                                    {{/if}}
                                </td>
                                <td>
                                    {{#if this.daysOverdue}}
                                        <span class="text-danger"><strong>{{this.daysOverdue}} days</strong></span>
                                    {{else}}
                                        -
                                    {{/if}}
                                </td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
                {{/if}}
            </div>
        </div>
    </div>

    <script nonce="{{cspNonce}}">
        function sendReminder(tenantId) {
            if (confirm('Send payment reminder to this tenant?')) {
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                fetch('/admin/send-reminder/' + tenantId, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        ...(csrfToken ? { 'X-CSRF-Token': csrfToken } : {}),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message || 'Reminder sent successfully!');
                })
                .catch(err => {
                    alert('Failed to send reminder');
                });
            }
        }
    </script>
</body>
</html>
